<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Get Your Drone Photography Quote</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="assets/css/styles.css">
  <link rel="stylesheet" href="assets/css/ai-overlay.css">
</head>

<body>
  <div class="app-container">
    <header class="app-header">
      <h1>Get Your Drone Photography Quote</h1>
      <p class="header-subtitle">Map your property and receive an instant quote</p>
    </header>
    <div class="main-content">
      <div class="map-area">
        <!-- Floating Action Button -->
        <div class="floating-controls">
          <button id="cancelPlotting" class="fab btn-warning is-hidden">Start Over</button>
        </div>

        <!-- AI Progress Overlay (Top Center) -->
        <div id="aiMapOverlay" class="ai-map-overlay ai-overlay-hidden">
          <div class="ai-card">
            <div class="ai-header">
              <span class="spinner"></span>
              <strong>AI Analysis in Progress</strong>
            </div>
            <div class="ai-progress-container">
              <div class="ai-progress-bar" id="aiProgressBar" style="width: 0%"></div>
            </div>
            <p id="aiProgressText">Analyzing satellite imagery...</p>
          </div>
        </div>

        <!-- Map Controls (minimal, top-right) -->
        <div class="map-controls">
          <div class="map-controls-group">
            <button id="startPlotting" class="btn btn-primary start-mapping-btn">Start Mapping Your Property</button>
          </div>
          <div class="map-controls-group">
            <input type="text" id="addressSearch" class="form-input search-input" placeholder="Search address...">
            <button id="searchAddress" class="btn btn-sm btn-primary">Search</button>
          </div>
          <div class="map-controls-group">
            <select id="measurementUnit" class="form-select" aria-label="Measurement Unit">
              <option value="acres">Acres</option>
              <option value="sqft">Square Feet</option>
              <option value="sqmeters">Square Meters</option>
              <option value="hectares">Hectares</option>
            </select>
            <button id="toggleSatellite" class="btn btn-sm btn-info">Satellite</button>
            <button id="clearAllPlots" class="btn btn-sm btn-warning">Clear All</button>
          </div>
          <div class="map-controls-group">
            <button id="finishPlotting" class="btn btn-submit is-hidden">Finish Mapping</button>
          </div>
        </div>

        <div id="map" class="map-container"></div>

        <!-- Measurement Card (bottom-left) -->
        <div class="measurement-card">
          <div class="measurement-value" id="measurementValue">0</div>
          <div class="measurement-unit-label" id="measurementUnitLabel">acres</div>
          <div class="measurement-label">Total Area</div>
        </div>
      </div>
      <div class="workflow-panel">
        <!-- Step Navigation -->
        <div class="step-navigation">
          <button id="prevStep" class="btn btn-secondary btn-nav" disabled>‚Üê Previous</button>
          <button id="nextStep" class="btn btn-primary btn-nav" disabled>Next ‚Üí</button>
        </div>

        <!-- Step 1: Map Your Property -->
        <div class="workflow-step active" id="workflowStep1">
          <div class="step-header">
            <span class="step-number">1</span>
            <h2>Map Your Property</h2>
            <span class="step-status" id="step1Status"></span>
          </div>
          <div class="step-content">
            <p class="step-instruction">Click on the map to mark the corners of your property. Start by clicking where
              one corner of your land is, then continue clicking around the boundary until you've outlined the entire
              area.</p>
            <p class="help-text">üí° <strong>Tip:</strong> Use the search box in the top-right to find your address
              quickly!</p>
            <p class="help-text" style="margin-top: 0.5rem;">Don't worry about being perfect - we can adjust the
              boundaries later if needed.</p>
            <ul class="step-tips">
              <li>Click to add corners, then drag points to fine-tune.</li>
              <li>Press Enter to finish, Esc to cancel, Ctrl/Cmd+Z to undo.</li>
            </ul>
            <div class="plotting-panel is-hidden" id="plottingPanel">
              <div class="plotting-status">
                <span id="pointCount">0</span> points plotted
                <div id="aiStatus" class="ai-status hidden"
                  style="margin-top: 5px; font-size: 0.85rem; color: #10b981;">
                  <span class="spinner"></span> AI sizing property...
                </div>
                <p class="help-text" style="margin-top: 0.5rem; font-size: 0.85rem;">Keep clicking to add more corners.
                  You need at least 3 points to create your property boundary.</p>
              </div>
              <button id="undoLastPoint" class="btn btn-sm btn-secondary" disabled>Undo Last Point</button>
            </div>
          </div>
        </div>

        <!-- Step 2: Mark Buildings (Optional) -->
        <div class="workflow-step" id="workflowStep2">
          <div class="step-header">
            <span class="step-number">2</span>
            <h2>Mark Buildings <span class="optional-badge">Optional</span></h2>
            <span class="step-status" id="step2Status"></span>
          </div>
          <div class="step-content">
            <div class="obstacle-panel is-hidden" id="obstaclePanel">
              <p class="step-instruction">If you have houses, barns, or other large buildings on your property, click on
                the map to mark their locations.</p>
              <p class="help-text">This helps us plan the safest and most efficient flight path for our drone.</p>
              <ul class="step-tips">
                <li>Select a building type, then click the map to drop a marker.</li>
                <li>Use Readjust Boundary to go back and fix your outline.</li>
              </ul>
              <div class="form-group">
                <label for="obstacleType">Building type</label>
                <select id="obstacleType" class="form-select" aria-label="Building type">
                  <option value="house">House</option>
                  <option value="garage">Garage</option>
                  <option value="shed">Shed</option>
                  <option value="barn">Barn</option>
                  <option value="dock">Dock</option>
                </select>
              </div>
              <button id="markHouse" class="btn btn-primary">Mark a Building</button>
              <p class="help-text is-hidden" id="markBuildingHint">Click on the map to place a building marker.</p>
              <div id="obstaclesList" class="obstacles-list"></div>
              <div class="poi-panel">
                <p class="step-instruction" style="margin-top: 1rem;">Mark any points of interest like gardens, pools,
                  rivers, or entrances.</p>
                <div class="form-group">
                  <label for="poiType">POI type</label>
                  <select id="poiType" class="form-select" aria-label="POI type">
                    <option value="garden">Garden</option>
                    <option value="pool">Pool</option>
                    <option value="pond">Pond</option>
                    <option value="river">River/Stream</option>
                    <option value="driveway">Driveway/Entrance</option>
                    <option value="viewpoint">Viewpoint</option>
                    <option value="trail">Trail</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <button id="markPoi" class="btn btn-info">Mark a POI</button>
                <p class="help-text is-hidden" id="markPoiHint">Click on the map to place a POI marker.</p>
                <div id="poiList" class="obstacles-list poi-list"></div>
              </div>
              <div class="obstacle-actions">
                <button id="readjustPlotting" class="btn btn-secondary">Readjust Boundary</button>
                <button id="resetPlot" class="btn btn-warning">Reset to Step 1</button>
                <button id="finishObstacleMarking" class="btn btn-success">Continue to Quote</button>
                <button id="skipObstacles" class="btn btn-secondary">No Buildings - Skip</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3: Get Your Quote -->
        <div class="workflow-step" id="workflowStep3">
          <div class="step-header">
            <span class="step-number">3</span>
            <h2>Get Your Quote</h2>
            <span class="step-status" id="step3Status"></span>
          </div>
          <div class="step-content">
            <div class="quote-section">
              <p class="step-instruction">Fill out your contact information below and we'll calculate your personalized
                quote based on your property size.</p>

              <!-- AI Status Indicator - moved here for visibility -->


              <ul class="step-tips">
                <li>Pick a package to control drone photo count.</li>
                <li>If the area looks off, go back and Readjust Boundary.</li>
                <li>
                  <strong>Local AI Not Working?</strong>
                  <button id="rerunAI" class="btn btn-sm btn-info" style="margin-left: 5px;">Rerun AI Analysis</button>
                  <a href="ai-setup.md" target="_blank"
                    style="font-size: 0.8rem; color: var(--info); margin-left: 10px;">Setup Guide</a>
                </li>
                <li>Most drone shots are angled; only the top-down shots show on the map.</li>
                <li>Hover over angle markers (red circles) on building orbits to see shot predictions and camera angles.
                </li>
              </ul>
              <div class="form-group">
                <label for="quotePackage"
                  style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; display: block;">Choose Your Drone
                  Photo Package</label>
                <div class="package-selector" id="packageSelector">
                  <!-- Packages will be dynamically inserted here -->
                </div>
                <input type="hidden" id="quotePackage" value="">
                <p class="help-text" id="quotePackageHint" style="margin-top: 1rem;"></p>
                <div class="package-summary is-hidden" id="quotePackageSummary">
                  <h4 style="margin-bottom: 0.75rem; color: var(--primary);">Package Details</h4>
                  <div class="package-summary-item">
                    <span>Property shots:</span>
                    <strong id="quotePackageLandCount">-</strong>
                  </div>
                  <div class="package-summary-item">
                    <span>Top-down shots:</span>
                    <strong id="quotePackageTopDownCount">-</strong>
                  </div>
                  <div class="package-summary-item">
                    <span>Angled shots:</span>
                    <strong id="quotePackageAngledCount">-</strong>
                  </div>
                  <div class="package-summary-item">
                    <span>Building shots:</span>
                    <strong id="quotePackageBuildingCount">-</strong>
                  </div>
                  <div class="package-summary-item total">
                    <span>Total drone photos:</span>
                    <strong id="quotePackagePhotoCount">-</strong>
                  </div>
                </div>
                <div class="quote-legend">
                  <div class="legend-block">
                    <h4>Shot Color Key</h4>
                    <div class="legend-items">
                      <div class="legend-item">
                        <span class="legend-dot legend-dot-topdown"></span>
                        <span>Top-down shots</span>
                      </div>
                      <div class="legend-item">
                        <span class="legend-dot legend-dot-angled"></span>
                        <span>Angled property shots</span>
                      </div>
                      <div class="legend-item">
                        <span class="legend-dot legend-dot-building"></span>
                        <span>Building orbit shots</span>
                      </div>
                    </div>
                  </div>
                  <div class="legend-block">
                    <h4>Package Totals</h4>
                    <div class="legend-items" id="packageTotalsLegend"></div>
                  </div>
                </div>
              </div>
              <form id="quoteForm" class="quote-form">
                <div class="form-group">
                  <label for="quoteCustomerName">Your Name *</label>
                  <input type="text" id="quoteCustomerName" class="form-input" required
                    placeholder="Enter your full name" aria-label="Your Name">
                </div>
                <div class="form-group">
                  <label for="quoteCustomerEmail">Email Address *</label>
                  <input type="email" id="quoteCustomerEmail" class="form-input" required
                    placeholder="your.email@example.com" aria-label="Email Address">
                </div>
                <div class="form-group">
                  <label for="quoteCustomerPhone">Phone Number</label>
                  <input type="tel" id="quoteCustomerPhone" class="form-input" placeholder="(555) 123-4567"
                    aria-label="Phone Number">
                </div>
                <div class="form-group">
                  <label for="quoteServiceType">Service Type *</label>
                  <select id="quoteServiceType" class="form-select" required aria-label="Service Type">
                    <option value="">Select service type...</option>
                  </select>
                </div>
                <input type="hidden" id="quoteArea" value="0">
                <input type="hidden" id="quoteAreaUnit" value="acres">
                <input type="hidden" id="quotePhotoCount" value="0">
                <input type="hidden" id="quoteCustomer" value="">
                <input type="hidden" id="quoteBasePrice" value="0">

                <div id="quotePriceBreakdown" class="quote-price-breakdown is-hidden">
                  <h4>Your Estimated Quote</h4>
                  <div class="quote-price-item">
                    <span>Property Area:</span>
                    <span id="quoteAreaDisplay">-</span>
                  </div>
                  <div class="quote-price-item">
                    <span>Drone Photos Needed:</span>
                    <span id="quotePhotoCountDisplay">-</span>
                  </div>
                  <div class="quote-price-item">
                    <span>Area Scaling:</span>
                    <span id="quoteAreaCost">$0.00</span>
                  </div>
                  <div class="quote-price-item">
                    <span>Additional Photo Processing:</span>
                    <span id="quotePhotoCost">$0.00</span>
                  </div>
                  <div class="quote-price-item">
                    <span>Estimated Total:</span>
                    <span id="quoteTotalCost">$0.00</span>
                  </div>
                </div>
                <button type="submit" class="btn btn-primary"
                  style="width: 100%; margin-top: 1rem; padding: 1rem; font-size: 1.1rem;">Request My Quote</button>
                <p class="help-text" style="text-align: center; margin-top: 0.5rem; font-size: 0.85rem;">We'll send your
                  detailed quote to your email within 24 hours.</p>
              </form>
            </div>
          </div>
        </div>

        <!-- Additional Tabs (Admin Only - Hidden from customers) -->
        <div class="additional-tabs is-hidden" id="adminTabs">
          <button class="tab-btn" data-tab="customers">Customers</button>
          <button class="tab-btn" data-tab="settings">Settings</button>
        </div>

        <div id="customersTab" class="tab-content">
          <div class="section">
            <h3>Customer Management</h3>
            <div class="search-box">
              <input type="text" id="customerSearch" class="form-input" placeholder="Search customers...">
              <button id="newCustomer" class="btn btn-primary">+ New Customer</button>
            </div>
            <div id="customerList" class="customer-list"></div>
          </div>
          <div class="section is-hidden" id="lotSection">
            <h3>Lot Management</h3>
            <div class="lot-info">
              <div id="selectedCustomerInfo"></div>
              <button id="newLot" class="btn btn-primary">+ New Lot</button>
            </div>
            <div id="lotList" class="lot-list"></div>
          </div>
          <div class="section is-hidden" id="lotVersionSection">
            <h3>Lot Versions</h3>
            <div id="lotVersionList" class="version-list"></div>
            <div id="lotComparison" class="lot-comparison is-hidden">
              <h4>Change Comparison</h4>
              <div id="comparisonMetrics"></div>
            </div>
          </div>
        </div>
        <div id="settingsTab" class="tab-content">
          <div class="section">
            <h3>Map Configuration</h3>
            <div class="form-group">
              <label for="defaultLat">Default Map Center (Latitude)</label>
              <input type="number" id="defaultLat" class="form-input" step="0.0001" value="44.8356"
                aria-label="Default Map Center Latitude">
            </div>
            <div class="form-group">
              <label for="defaultLng">Default Map Center (Longitude)</label>
              <input type="number" id="defaultLng" class="form-input" step="0.0001" value="-69.2733"
                aria-label="Default Map Center Longitude">
            </div>
            <div class="form-group">
              <label for="defaultZoom">Default Zoom Level</label>
              <input type="number" id="defaultZoom" class="form-input" min="1" max="18" value="13"
                aria-label="Default Zoom Level">
            </div>
          </div>
          <div class="section">
            <h3>Company Information</h3>
            <div class="form-group">
              <label for="companyName">Company Name</label>
              <input type="text" id="companyName" class="form-input" placeholder="Your Company Name"
                aria-label="Company Name">
            </div>
          </div>
          <div class="section">
            <h3>Pricing Configuration</h3>
            <div class="form-group">
              <label for="basePricePerAcre">Base Pricing (per acre)</label>
              <input type="number" id="basePricePerAcre" class="form-input" step="0.01" value="250"
                aria-label="Base Pricing per acre">
            </div>
            <div class="form-group">
              <label for="photoProcessingCost">Drone Photo Processing Cost (per photo)</label>
              <input type="number" id="photoProcessingCost" class="form-input" step="0.01" value="0.50"
                aria-label="Drone Photo Processing Cost per photo">
            </div>
            <div class="form-group">
              <label for="photoMultiplier">Photo Multiplier</label>
              <input type="number" id="photoMultiplier" class="form-input" step="0.1" value="1.0"
                aria-label="Photo Multiplier">
            </div>
            <div class="form-group">
              <label for="minimumPrice">Minimum Price</label>
              <input type="number" id="minimumPrice" class="form-input" step="0.01" value="100"
                aria-label="Minimum Price">
            </div>
          </div>
          <div class="section">
            <h3>Drone Specifications</h3>
            <div class="form-group">
              <label for="droneModel">Drone Model</label>
              <input type="text" id="droneModel" class="form-input" placeholder="DJI Mini 3" aria-label="Drone Model">
            </div>
            <div class="form-group">
              <label for="sensorWidth">Sensor Width (mm)</label>
              <input type="number" id="sensorWidth" class="form-input" step="0.1" value="15.7"
                aria-label="Sensor Width in millimeters">
            </div>
            <div class="form-group">
              <label for="sensorHeight">Sensor Height (mm)</label>
              <input type="number" id="sensorHeight" class="form-input" step="0.1" value="10.5"
                aria-label="Sensor Height in millimeters">
            </div>
            <div class="form-group">
              <label for="focalLength">Focal Length (mm, 35mm equivalent)</label>
              <input type="number" id="focalLength" class="form-input" step="0.1" value="24"
                aria-label="Focal Length in millimeters, 35mm equivalent">
            </div>
            <div class="form-group">
              <label for="imageWidth">Image Width (pixels)</label>
              <input type="number" id="imageWidth" class="form-input" step="1" value="4000"
                aria-label="Image Width in pixels">
            </div>
            <div class="form-group">
              <label for="imageHeight">Image Height (pixels)</label>
              <input type="number" id="imageHeight" class="form-input" step="1" value="3000"
                aria-label="Image Height in pixels">
            </div>
            <div class="form-group">
              <label for="maxAltitude">Max Altitude (meters)</label>
              <input type="number" id="maxAltitude" class="form-input" step="1" value="120"
                aria-label="Max Altitude in meters">
            </div>
            <div class="form-group">
              <label for="defaultAltitude">Default Altitude (meters)</label>
              <input type="number" id="defaultAltitude" class="form-input" step="1" value="60"
                aria-label="Default Altitude in meters">
            </div>
          </div>
          <div class="section">
            <h3>Coverage Defaults</h3>
            <div class="form-group">
              <label for="defaultFrontOverlap">Default Front Overlap (%)</label>
              <input type="number" id="defaultFrontOverlap" class="form-input" step="1" min="0" max="100" value="70"
                aria-label="Default Front Overlap percentage">
            </div>
            <div class="form-group">
              <label for="defaultSideOverlap">Default Side Overlap (%)</label>
              <input type="number" id="defaultSideOverlap" class="form-input" step="1" min="0" max="100" value="60"
                aria-label="Default Side Overlap percentage">
            </div>
            <div class="form-group">
              <label for="targetGSD">Target GSD (cm/pixel)</label>
              <input type="number" id="targetGSD" class="form-input" step="0.1" min="0.5" max="10" value="2.5"
                aria-label="Target GSD in centimeters per pixel">
            </div>
          </div>
          <div class="section">
            <h3>Flight Path Defaults</h3>
            <div class="form-group">
              <label for="propertyOrbitOffsetMeters">Property orbit offset (meters)</label>
              <input type="number" id="propertyOrbitOffsetMeters" class="form-input" step="1" min="0" value="10"
                aria-label="Property orbit offset in meters">
            </div>
          </div>
          <div class="section">
            <h3>AI Configuration</h3>
            <div class="form-group">
              <label>Local AI Service</label>
              <p class="help-text">Using LLaVA model at http://192.168.50.67:1234</p>
              <button id="testAIConnection" class="btn btn-info">Test Connection</button>
            </div>
          </div>
          <button id="saveSettings" class="btn btn-primary">Save Settings</button>
        </div>
      </div>
    </div>
  </div>
  <div id="customerModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 id="customerModalTitle">New Customer</h2>
      <form id="customerForm">
        <input type="hidden" id="customerId">
        <div class="form-group">
          <label for="customerName">Name *</label>
          <input type="text" id="customerName" class="form-input" required aria-label="Customer Name">
        </div>
        <div class="form-group">
          <label for="customerEmail">Email</label>
          <input type="email" id="customerEmail" class="form-input" aria-label="Customer Email">
        </div>
        <div class="form-group">
          <label for="customerPhone">Phone</label>
          <input type="tel" id="customerPhone" class="form-input" aria-label="Customer Phone">
        </div>
        <div class="form-group">
          <label for="customerAddress">Address</label>
          <input type="text" id="customerAddress" class="form-input" aria-label="Customer Address">
        </div>
        <div class="form-group">
          <label for="customerNotes">Notes</label>
          <textarea id="customerNotes" class="form-textarea" rows="3" aria-label="Customer Notes"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Save Customer</button>
      </form>
    </div>
  </div>
  <div id="lotModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 id="lotModalTitle">New Lot</h2>
      <form id="lotForm">
        <input type="hidden" id="lotId">
        <input type="hidden" id="lotCustomerId">
        <div class="form-group">
          <label for="lotName">Lot Name *</label>
          <input type="text" id="lotName" class="form-input" required aria-label="Lot Name">
        </div>
        <div class="form-group">
          <label for="lotNumber">Lot Number</label>
          <input type="text" id="lotNumber" class="form-input" aria-label="Lot Number">
        </div>
        <div class="form-group">
          <label for="parcelId">Parcel ID</label>
          <input type="text" id="parcelId" class="form-input" aria-label="Parcel ID">
        </div>
        <div class="form-group">
          <label for="lotNotes">Notes</label>
          <textarea id="lotNotes" class="form-textarea" rows="3" aria-label="Lot Notes"></textarea>
        </div>
        <div class="form-group">
          <label>Save current drawing as lot boundary?</label>
          <button type="button" id="saveCurrentDrawing" class="btn btn-info">Save Current Drawing</button>
        </div>
        <button type="submit" class="btn btn-primary">Save Lot</button>
      </form>
    </div>
  </div>
  <div id="quotePreviewModal" class="modal">
    <div class="modal-content large">
      <span class="close">&times;</span>
      <div id="quotePreview"></div>
      <div class="modal-actions">
        <button id="exportQuote" class="btn btn-primary">Export Quote</button>
        <button id="printQuote" class="btn btn-secondary">Print</button>
      </div>
    </div>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-image@0.4.0/leaflet-image.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <script src="config.js"></script>
  <script src="assets/js/utils.js"></script>
  <script src="assets/js/storage.js"></script>
  <script src="assets/js/measurements.js"></script>
  <script src="assets/js/coverage.js"></script>
  <script src="assets/js/plotting.js"></script>
  <script src="assets/js/customers.js"></script>
  <script src="assets/js/lotHistory.js"></script>
  <script src="assets/js/quote.js"></script>
  <script src="assets/js/ai-placement.js"></script>
  <script src="assets/js/map.js"></script>
  <script src="assets/js/app.js"></script>
</body>

</html>